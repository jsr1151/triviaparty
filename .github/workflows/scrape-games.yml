name: Scrape J-Archive Games

on:
  workflow_dispatch:
    inputs:
      season_from:
        description: 'Start season (e.g. 1)'
        required: false
        default: '1'
      season_to:
        description: 'End season (e.g. 40)'
        required: false
        default: '40'
      game_ids:
        description: >
          Space-separated J-Archive game IDs (e.g. "173 174 175").
          If set, overrides season range.
        required: false
        default: ''
      delay_ms:
        description: 'Delay between games in ms'
        required: false
        default: '750'
      retries:
        description: 'Retries per game/list fetch'
        required: false
        default: '3'
      retry_backoff_ms:
        description: 'Base retry backoff in ms'
        required: false
        default: '1500'
      max_games:
        description: 'Optional safety limit (0 = no limit)'
        required: false
        default: '0'
      target_ref:
        description: 'Branch to run on and push to (defaults to current ref)'
        required: false
        default: ''
  schedule:
    - cron: '30 6 * * *'

permissions:
  contents: write

concurrency:
  group: scrape-jarchive-${{ github.ref }}
  cancel-in-progress: false

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_ref || github.ref_name }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Scrape games
        run: |
          SEASON_FROM="${{ github.event.inputs.season_from || '1' }}"
          SEASON_TO="${{ github.event.inputs.season_to || '40' }}"
          GAME_IDS="${{ github.event.inputs.game_ids }}"
          DELAY_MS="${{ github.event.inputs.delay_ms || '750' }}"
          RETRIES="${{ github.event.inputs.retries || '3' }}"
          RETRY_BACKOFF_MS="${{ github.event.inputs.retry_backoff_ms || '1500' }}"
          MAX_GAMES="${{ github.event.inputs.max_games || '0' }}"

          if [ -n "$GAME_IDS" ]; then
            echo "Scraping explicit game IDs: $GAME_IDS"
            npm run scrape -- $GAME_IDS --delay-ms "$DELAY_MS" --retries "$RETRIES" --retry-backoff-ms "$RETRY_BACKOFF_MS" --max-games "$MAX_GAMES"
          else
            echo "Scraping season range ${SEASON_FROM}-${SEASON_TO}..."
            npm run scrape -- --season-from "$SEASON_FROM" --season-to "$SEASON_TO" --delay-ms "$DELAY_MS" --retries "$RETRIES" --retry-backoff-ms "$RETRY_BACKOFF_MS" --max-games "$MAX_GAMES"
          fi

      - name: Commit scraped JSON files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          rm -f public/data/jeopardy/scrape-failures.json
          git add public/data/jeopardy/ docs/data/jeopardy/
          git diff --staged --quiet && echo "Nothing new to commit" && exit 0
          SEASON_FROM="${{ github.event.inputs.season_from || '1' }}"
          SEASON_TO="${{ github.event.inputs.season_to || '40' }}"
          GAME_IDS="${{ github.event.inputs.game_ids }}"
          if [ -n "$GAME_IDS" ]; then
            LABEL="games"
          else
            LABEL="seasons-${SEASON_FROM}-to-${SEASON_TO}"
          fi
          git commit -m "feat: add scraped Jeopardy games ($LABEL)"
          git push
